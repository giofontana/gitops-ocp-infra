apiVersion: batch/v1
kind: Job
metadata:
  name: set-default-sc-for-odf
  generateName: set-default-sc-for-odf-
spec:
  template:
    spec:
      containers:
        - name: default-sc-setter
          image: registry.redhat.io/openshift4/ose-cli
          env:
            - name: default_storage_class_name
              value: "ocs-storagecluster-ceph-rbd"
          command:
            - /bin/bash
            - -c
            - |
              
              SC_NAME="${default_storage_class_name}"
              TIMEOUT=1800  # 30 minutes in seconds
              WAIT_TIME=120  # 2 minutes in seconds
              ELAPSED=0
              
              echo "Searching for storage class: ${SC_NAME}"
              
              while [ $ELAPSED -lt $TIMEOUT ]; do
                if oc get storageclass "${SC_NAME}" > /dev/null 2>&1; then
                  echo "Storage class found! Setting ${SC_NAME} as default..."
                  oc patch storageclass "${SC_NAME}" -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
                  echo "Successfully set ${SC_NAME} as default storage class"
                  exit 0
                fi
                
                echo "Storage class ${SC_NAME} not found. Waiting 2 minutes before retrying... (${ELAPSED}/${TIMEOUT} seconds elapsed)"
                sleep $WAIT_TIME
                ELAPSED=$((ELAPSED + WAIT_TIME))
              done
              
              echo "ERROR: Storage class ${SC_NAME} not found after 30 minutes timeout"
              exit 1
      restartPolicy: Never
      serviceAccount: ocs-default-sc-setter
      serviceAccountName: ocs-default-sc-setter
  backoffLimit: 4
